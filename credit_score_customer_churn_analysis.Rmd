---
title: "Customer Churn Analysis in the Banking Industry"
author: "Team: SNM Analytics"
# date: "today"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=F}
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific = T, digits = 3)
# Loading Required libraries
library(ezids)
library(tidyverse)
library(ggplot2)
```

```{r}
churn_data <- data.frame(read.csv("Data.csv"))
```

```{r}
str(churn_data)
```

```{r}
rows <- nrow(churn_data)
cols <- ncol(churn_data)
```

Our data set has `r rows` observations and `r cols` variables


```{r}
xkablesummary(churn_data)
```

```{r}
na_count <- colSums(is.na(churn_data))

if (all(na_count == 0)) {
  cat("There are no missing values in the data set.\n")
} else {
  cat("There are some missing values in the data set.\n")
}
```
As We don’t have any missing values in this data set, we don’t need to do anything extra to handle them. 

As defined in our smart question, We only want to look at customers who have a positive balance as they are more valuable customers. We will filter out the data with zero balance.

```{r}
churn_data_filtered <- churn_data %>% filter(Balance > 0)
filtered_rows <- nrow(churn_data_filtered)
```
The filtered data set excluding zero balance has `r filtered_rows` observations



```{r}
# Calculate summary statistics of CreditScore by Exited
churn_credit_score_summary <- churn_data_filtered %>%
  group_by(Exited) %>%
  summarize(
    mean_credit_score = mean(CreditScore),
    sd_credit_score = sd(CreditScore),
    min_credit_score = min(CreditScore),
    max_credit_score = max(CreditScore)
  )

# Print summary table
xkabledply(churn_credit_score_summary)
```

### Churn Data Credit Score Summary

The churn data credit score summary provides a comparison of the credit score statistics between customers who have churned (`Exited = 1`) and customers who have not churned (`Exited = 0`). The summary is calculated on the dataset that includes customers with a balance greater than zero and without removing any outliers. The summary consists of the following columns:

- `Exited`: Churn status (0 for not churned, 1 for churned)
- `mean_credit_score`: Mean credit score for each group
- `sd_credit_score`: Standard deviation of credit scores for each group
- `min_credit_score`: Minimum credit score for each group
- `max_credit_score`: Maximum credit score for each group

The summary table shows that the mean credit score is slightly higher for customers who have not churned (653) compared to customers who have churned (646). The standard deviation for credit scores is also slightly lower for customers who have not churned (95.8) than for customers who have churned (100). The minimum and maximum credit scores for both groups are quite similar, with the lowest credit score for the churned group being 350 and the highest credit score for both groups being 850. This suggests that there is some difference in the variability of credit scores between the two groups of customers. However, this difference may not be very significant or meaningful, as both groups have relatively high standard deviations compared to their mean credit scores. We will perform further analysis or use other measures to better understand how credit score affects customer churn.

Lets also visualize the same on graphs. 


```{r}
ggplot(churn_data_filtered, aes(x = factor(Exited), y = CreditScore, fill = factor(Exited))) +
  geom_boxplot() +
  labs(x = "Churn Status (0 = Not Churned, 1 = Churned)", y = "Credit Score", fill = "Churn Status") +
  theme_minimal() +
  ggtitle("Credit Score Distribution by Churn Status") +
  scale_fill_manual(values = c("0" = "lightgreen", "1" = "indianred1"), labels = c("0" = "Not Churned (0)", "1" = "Churned (1)"))
```

### Box Plot of Credit Score Distribution by Churn Status

The box plot for the given data displays the distribution of credit scores by churn status. It has two box plots, one for customers who have not churned (`Exited = 0`) and one for customers who have churned (`Exited = 1`).

Each box plot has the following key components:

- **Median** (the horizontal line inside the box): This represents the middle value of the credit scores in each group.
- **Lower quartile** (the left edge of the box): This represents the value below which 25% of the credit scores in each group lie.
- **Upper quartile** (the right edge of the box): This represents the value below which 75% of the credit scores in each group lie.
- **Interquartile range** (IQR, the width of the box): This represents the range within which the middle 50% of the credit scores in each group lie.
- **Whiskers** (the lines extending from the box): These represent the range of credit scores that are within 1.5 times the IQR from the lower and upper quartiles.
- **Outliers** (individual points outside the whiskers): These represent credit scores that fall outside the whisker range and are considered unusual or extreme values.

Based on the box plot, we can make the following observations:

- The median credit score for both groups (churned and not churned) is quite similar(around 650), indicating that there might not be a significant difference in *the central tendency* of credit scores between
the two groups.

- The overall range of credit scores and *the interquartile ranges* for both groups are also quite similar, suggesting that *the spread* of credit scores is not considerably different between the churned and not churned groups.

- There might be a few outliers in both groups, but their presence seems to be more visible in churned customers.



```{r}
ggplot(churn_data_filtered, aes(x = CreditScore, fill = factor(Exited))) +
  geom_density(alpha = 0.5) +
  labs(x = "Credit Score", y = "Density", fill = "Churn Status") +
  theme_minimal() +
  ggtitle("Credit Score Distribution Density by Churn Status") +
  scale_fill_manual(values = c("0" = "lightgreen", "1" = "indianred1"), labels = c("0" = "Not Churned (0)", "1" = "Churned (1)"))
```

The density plot for the given data displays the distribution of credit scores by churn status using smooth, continuous lines. The plot has two density curves:

- **Customers who have not churned** (Exited = 0): shown in light green
- **Customers who have churned** (Exited = 1): shown in indianred1

The density plot illustrates the following key aspects:

1. **The shape of the two density curves**: This shows how the credit scores are distributed for each group. Both curves appear to have a similar shape, with a single peak (unimodal) and a slightly right-skewed distribution.

2. **The peaks of the density curves**: These represent the most common credit scores in each group. The peak for customers who have not churned is slightly higher than the peak for customers who have churned, indicating that there might be a small difference in the mode of the credit scores between the two groups.

3. **The overlap between the density curves**: The considerable overlap between the two curves suggests that there is no clear separation in the distribution of credit scores between customers who have churned and those who have not churned. This indicates that credit score alone may not be a strong predictor of customer churn.

In conclusion, the density plot shows that the distribution of credit scores for customers who have churned and those who have not churned is quite similar. Both groups have a single peak and a slightly right-skewed distribution. While there is a small difference in the mode of the credit scores between the two groups, the considerable overlap between the curves suggests that credit score alone may not be a strong indicator of whether a customer is likely to churn or not. May be removing the outliers would give us a more clearer picture.

```{r}

# Function to remove outliers using IQR method
remove_outliers <- function(data, column_name) {
  q1 <- quantile(data[[column_name]], 0.25)
  q3 <- quantile(data[[column_name]], 0.75)
  iqr <- q3 - q1
  lower_bound <- q1 - 1.5 * iqr
  upper_bound <- q3 + 1.5 * iqr
  data_filtered <- data[data[[column_name]] >= lower_bound & data[[column_name]] <= upper_bound, ]
  return(data_filtered)
}

# Remove outliers for CreditScore
churn_data_no_outliers <- remove_outliers(churn_data_filtered, "CreditScore")
```

```{r}
churn_credit_score_no_outliers_summary <- churn_data_no_outliers %>%
  group_by(Exited) %>%
  summarize(
    mean_credit_score = mean(CreditScore),
    sd_credit_score = sd(CreditScore),
    min_credit_score = min(CreditScore),
    max_credit_score = max(CreditScore)
  )

xkabledply(churn_credit_score_no_outliers_summary)
```
```{r}
ggplot(churn_data_no_outliers, aes(x = factor(Exited), y = CreditScore, fill = factor(Exited))) +
  geom_boxplot() +
  labs(x = "Churn Status (0 = Not Churned, 1 = Churned)", y = "Credit Score", fill = "Churn Status") +
  theme_minimal() +
  ggtitle("Credit Score Distribution by Churn Status (Outliers Removed)") +
  scale_fill_manual(values = c("0" = "lightgreen", "1" = "indianred1"), labels = c("0" = "Not Churned (0)", "1" = "Churned (1)"))
```

```{r}
ggplot(churn_data_no_outliers, aes(x = CreditScore, fill = factor(Exited))) +
  geom_density(alpha = 0.5) +
  labs(x = "Credit Score", y = "Density", fill = "Churn Status") +
  theme_minimal() +
  ggtitle("Credit Score Distribution Density by Churn Status (Outliers Removed)") +
  scale_fill_manual(values = c("0" = "lightgreen", "1" = "indianred1"), labels = c("0" = "Not Churned (0)", "1" = "Churned (1)"))
```

Before removing outliers, the box plots and density plots for credit scores by churn status show:

- A median credit score of 655 for customers who have not churned (Exited = 0) and 646 for customers who have churned (Exited = 1).
- A wider interquartile range (IQR) for the churned group (Exited = 1) due to a higher standard deviation of 100.3 compared to 95.8 for the not churned group (Exited = 0).
- Some possible outliers in the lower range of credit scores for the churned group (Exited = 1).
- Considerable overlap between the density curves, suggesting credit score alone may not be a strong predictor of customer churn.

After removing outliers, the updated box plots and density plots for credit scores by churn status show:

- A median credit score that remains at 655 for customers who have not churned (Exited = 0) and slightly increases to 647 for customers who have churned (Exited = 1).
- A slightly narrower IQR for the churned group (Exited = 1) due to a reduced standard deviation of 97.9 compared to the original 100.3.
- Cleaner box plots without extreme values that might have distorted the distribution.
- Overlap between the density curves still present, reinforcing the observation that credit score alone may not be a strong predictor of customer churn.



```{r}
# Function to calculate summary statistics
summary_stats <- function(data, column_name, group_by_column) {
  stats <- data %>%
    group_by(!!sym(group_by_column)) %>%
    summarize(
      mean = mean(!!sym(column_name), na.rm = TRUE),
      sd = sd(!!sym(column_name), na.rm = TRUE),
      median = median(!!sym(column_name), na.rm = TRUE),
      min = min(!!sym(column_name), na.rm = TRUE),
      max = max(!!sym(column_name), na.rm = TRUE)
    )
  return(stats)
}

# Calculate summary statistics for credit scores by churn status
credit_score_stats <- summary_stats(churn_data_no_outliers, "CreditScore", "Exited")
xkabledply(summary_stats(churn_data_filtered, "CreditScore", "Exited"))
xkabledply(credit_score_stats)
```